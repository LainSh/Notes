# C++ - 内存管理


### 1.内存分配方式

**栈**：在执行函数时，函数内**局部变量**的存储单元都可以在栈上创建，函数执行结束时这些存储单元自动被释放。栈内存分配运算内置于处理器的指令集中，效率很高，但是分配的内存容量有限。

**堆**：就是那些由**new**分配的内存块，他们的释放编译器不去管，由我们的应用程序去控制，一般一个**new**就要对应一个**delete**。如果程序员没有释放掉，那么在程序结束后，操作系统会自动回收。

**自由存储区**：就是那些由**malloc**等分配的内存块，他和堆是十分相似的，不过它是用**free**来结束自己的生命的。

**全局/静态存储区**：全局变量和静态变量被分配到同一块内存中，在以前的C语言中，全局变量又分为初始化的和未初始化的，在C++里面没有这个区分了，他们共同占用同一块内存区。

**常量存储区**：这是一块比较特殊的存储区，他们里面存放的是常量，不允许修改。

### 2.堆和栈的区别
- 管理方式不同：
    *栈*，由编译器自动管理；
    *堆*，释放工作由程序员来控制，容易产生内存泄漏。
- 空间大小不同
    *栈*，的空间比较小；
    *堆*，的空间几乎没有什么限制。
- 能否产生碎片不同
    *栈*，不会产生碎片问题；
    *堆*，由于频繁的new/delete势必造成内存空间不连续，从而造成大量碎片，使程序效率降低。
- 生长方式不同
    *栈*，的生长方向是向下的，是向着内存地址减小的方向增长；
    *堆*，的生长方向是向上的，向着内存地址增加的方向。
- 分配方式不同
    *栈*，有两种分配方式：静态分配和动态分配，静态分配是编译器完成的，比如局部变量，动态分配是由alloca函数进行分配的，但是栈的动态分配由编译器来释放，无需我们手工实现；
    *堆*，都是动态分配的，没有静态分配的堆。
- 分配效率不同
    *栈*，是机器系统提供的数据结构，计算机会在底层对栈提供支持：分配专门的寄存器存放栈的地址，压栈出栈都有专门的指令执行，这就决定了栈的效率比较高。
    *堆*，则是C/C++函数库提供的，它的机制是很复杂的，例如为了分配一块内存，库函数会按照一定的算法（具体的算法可以参考数据结构/操作系统）在堆内存中搜索可用的足够大小的空间，如果没有足够大小的空间（可能是由于内存碎片太多），就有可能调用系统功能去增加程序数据段的内存空间，这样就有机会分到足够大小的内存，然后进行返回。显然，堆的效率比栈要低得多。

### 3.常见的内存错误及其对策
- 内存分配未成功却使用了它。常用解决办法是，在使用内存之前检查指针是否为NULL。如果指针p是函数的参数，那么在函数的入口处用assert(p!=NULL)进行检查。如果是用malloc或new来申请内存，应该用if(p==NULL) 或if(p!=NULL)进行防错处理。



